<!-- SUPERFLUID CAT PROTOTYPE -->
<!DOCTYPE html> 
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>suPURR Fluid Prototype</title>
  <style>
    body {
      margin: 0;
      background: black;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    .background-gradient {
      position: fixed;
      inset: 0;
      background: linear-gradient(to bottom, #000000 25%, #37025A 55%, #8a2be2 70%, #c71585 80%, #c71585 97%, #c71585 100%);
      opacity: 1;
      z-index: -2;
    }

    .dreamy-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.1);
      backdrop-filter: blur(30px);
      pointer-events: none;
      z-index: -1;
    }

    #gameCanvas {
      position: absolute !important;  
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;  
      height: 100% !important;  
      max-width: 100% !important;
      max-height: 100% !important;
      margin: 0 !important;
      padding: 0 !important;
      display: block;
      z-index: 10;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      background: rgba(0,0,0,0.1);
    }

    /* ========================= MOBILE CONTROLS ========================= */
    #controls {
      position: fixed;
      display: none;
      pointer-events: none;
      z-index: 200;
    }

    .joystick {
      position: absolute;
      bottom: 20px;
      left: 30px;
      width: 110px;
      height: 110px;
      background-image: radial-gradient(rgba(0, 40, 40, 0.9), rgba(0, 70, 70, 0.8),  rgba(0, 80, 80, 0.7), rgba(0, 90, 90, 0.6), rgba(0, 135, 135, 0.5), rgba(0, 150, 150, 0.4), rgba(0, 140, 140, 0.4), rgba(0, 130, 130, 0.4), rgba(0, 120, 120, 0.4));
      border: 2px solid  #00FFFF;
      border-radius: 50%;
      pointer-events: auto;
      user-select: none;
      -webkit-user-select: none;
      touch-action: none;
      transition: background 0.2s;
      box-shadow: 0 0 10px rgba(0, 76, 76,0.9);
    }

    .joystick.active {
      background: rgba(0, 255, 255, 0.5);
    }

    .joystick-knob {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 50px;
      height: 50px;
      background-image: radial-gradient(rgba(0, 124, 124, 0.7), rgba(0, 190, 190, 0.7), rgba(0, 124, 124, 0.7), rgba(0,190,190, 0.7), rgba(0, 124, 124, 0.7), rgba(0,190,190, 0.7), rgba(0, 124, 124, 0.7), rgba(0,190,190, 0.7), rgba(0, 124, 124, 0.7), rgba(0,190,190, 0.8), rgba(0, 124, 124, 0.9));
      border: 3px solid #02ffff;
      border-radius: 50%;
      pointer-events: none;
      box-shadow: 0 0 15px rgba(0, 150, 150, 0.5);
    }

    .jump-btn {
      position: absolute;
      bottom: 25px;
      right: 35px;
      font-size: 3rem;
      color: #00FFFF;
      background: rgba(0, 89, 89, 0.4);
      border: 3px solid #00FFFF;
      border-radius: 50%;
      width: 100px;
      height: 100px;
      pointer-events: auto;
      user-select: none;
      -webkit-user-select: none;
      touch-action: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      transition: background 0.2s;
      z-index: 1000 !important;
    }

    .jump-btn:active {
      background: rgba(0, 255, 255, 0.9);
    }

    #controls.landscape {
      inset: 0;
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      padding: 0 20px 20px;
    }

    #controls.landscape .joystick {
      position: relative;
      margin-bottom: 0;
    }

    #controls.landscape .jump-btn {
      position: relative;
      margin-bottom: 0;
    }

    #controls.portrait {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 35vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(180deg, rgba(50, 50, 70, 0.9) 0%, rgba(30, 30, 50, 0.95) 100%);
      border-top: 4px solid #9090C0;
    }

    #controls.portrait .joystick {
      position: absolute;
      left: 10%;
      top: 50%;
      transform: translateY(-50%);
    }

    #controls.portrait .jump-btn {
      position: absolute;
      right: 10%;
      top: 50%;
      transform: translateY(-50%);
    }

    @media (max-width: 700px) {
      .joystick {
        width: 100px;
        height: 100px;
      }

      .joystick-knob {
        width: 40px;
        height: 40px;
      }

      .jump-btn {
        width: 100px;
        height: 100px;
        font-size: 2.3rem;
      }
    }

    .info {
      position: fixed;
      top: 10px;
      left: 10px;
      color: #00FFFF;
      font-family: monospace;
      font-size: 14px;
      text-shadow: 2px 2px 4px black;
      z-index: 150;
      pointer-events: none;
      line-height: 1.6;
    }
  </style>
</head>
<body>
<div class="dreamy-overlay"></div>
<div class="background-gradient"></div>

<canvas id="gameCanvas"></canvas>

<!--<div class="info">
  <div>üê± suPURR Fluid Physics Test</div>
  <div>Movement: Arrow Keys / Joystick</div>
  <div>Jump: Space / Button</div>
  <div>ZERO FRICTION MODE ‚ú®</div>
</div>-->

<!-- MOBILE CONTROLS -->
<div id="controls">
  <div class="joystick">
    <div class="joystick-knob"></div>
  </div>
  <div class="jump-btn"><img src="assets/images/jump.png"></div>
</div>

<script src="https://unpkg.com/kaplay@latest/dist/kaplay.js"></script>

<script>
// ======================================== SETUP ========================================
const VIRTUAL_W = 1000;
const VIRTUAL_H = 480;

const k = kaplay({
  width: VIRTUAL_W,
  height: VIRTUAL_H,
  letterbox: true,
  background: [11, 11, 27, 0],
  global: false,
  canvas: document.getElementById("gameCanvas"),
  debug: true,
  stretch: true,
  crisp: true,
});

window.k = k;
Object.assign(window, k);

// ======================================== MOBILE CONTROLS ========================================
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                  ('ontouchstart' in window);
const controls = document.getElementById('controls');
const joystick = document.querySelector('.joystick');
const joystickKnob = document.querySelector('.joystick-knob');
const jumpBtn = document.querySelector('.jump-btn');

const virtualKeys = {
  left: false,
  right: false,
  space: false
};

if (controls) {
  const updateOrientation = () => {
    const isPortrait = window.innerHeight > window.innerWidth;
    controls.className = isPortrait ? 'portrait' : 'landscape';
    
    if (isMobile) {
      controls.style.display = 'flex';
    }
  };
  
  updateOrientation();
  window.addEventListener('resize', updateOrientation);
  window.addEventListener('orientationchange', updateOrientation);
  
  let hasShown = false;
  window.addEventListener('touchstart', () => {
    if (!hasShown) {
      hasShown = true;
      controls.style.display = 'flex';
      updateOrientation();
    }
  }, { once: true });
}

let joystickActive = false;
let joystickCenter = { x: 0, y: 0 };
const joystickRadius = 60;
const deadZone = 15;

function updateJoystick(touch) {
  if (!joystickActive) return;
  
  const rect = joystick.getBoundingClientRect();
  joystickCenter.x = rect.left + rect.width / 2;
  joystickCenter.y = rect.top + rect.height / 2;
  
  const deltaX = touch.clientX - joystickCenter.x;
  const deltaY = touch.clientY - joystickCenter.y;
  const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
  
  const clampedDistance = Math.min(distance, joystickRadius);
  const angle = Math.atan2(deltaY, deltaX);
  
  const knobX = Math.cos(angle) * clampedDistance;
  const knobY = Math.sin(angle) * clampedDistance;
  
  joystickKnob.style.transform = `translate(calc(-50% + ${knobX}px), calc(-50% + ${knobY}px))`;
  
  if (Math.abs(deltaX) > deadZone) {
    virtualKeys.left = deltaX < 0;
    virtualKeys.right = deltaX > 0;
  } else {
    virtualKeys.left = false;
    virtualKeys.right = false;
  }
}

function resetJoystick() {
  joystickActive = false;
  joystick.classList.remove('active');
  joystickKnob.style.transform = 'translate(-50%, -50%)';
  virtualKeys.left = false;
  virtualKeys.right = false;
}

if (joystick) {
  joystick.addEventListener('touchstart', (e) => {
    e.preventDefault();
    joystickActive = true;
    joystick.classList.add('active');
    updateJoystick(e.touches[0]);
  });
  
  joystick.addEventListener('touchmove', (e) => {
    e.preventDefault();
    updateJoystick(e.touches[0]);
  });
  
  joystick.addEventListener('touchend', (e) => {
    e.preventDefault();
    resetJoystick();
  });
  
  joystick.addEventListener('touchcancel', (e) => {
    e.preventDefault();
    resetJoystick();
  });
}

if (jumpBtn) {
  jumpBtn.addEventListener('touchstart', (e) => {
    e.preventDefault();
    virtualKeys.space = true;
  });
  
  jumpBtn.addEventListener('touchend', (e) => {
    e.preventDefault();
    virtualKeys.space = false;
  });
  
  jumpBtn.addEventListener('touchcancel', (e) => {
    e.preventDefault();
    virtualKeys.space = false;
  });
}

const originalIsKeyDown = isKeyDown;
const originalOnKeyPress = onKeyPress;  
let lastSpaceState = false;
let spaceHandlers = [];

window.isKeyDown = function(key) {
  if (virtualKeys[key]) return true;
  return originalIsKeyDown(key);
};

window.onKeyPress = function(key, callback) {
  if (key === "space") {
    spaceHandlers.push(callback);
  }
  return originalOnKeyPress(key, callback);  
};

let checkMobileInput = () => {
  if (virtualKeys.space && !lastSpaceState) {
    spaceHandlers.forEach(handler => handler());
  }
  lastSpaceState = virtualKeys.space;
};

setInterval(checkMobileInput, 16);

// ======================================== PHYSICS ========================================
setGravity(1500);
// SUPERFLUID PHYSICS CONSTANTS
const ACCELERATION = 30;  
const MAX_SPEED = 600;    
const JUMP_FORCE = 780;

// ======================================== LOAD SPRITES ========================================
loadSprite("niels", "assets/images/Niels.png", {
  sliceX: 12,
  sliceY: 1,
  anims: {
    walk: {
      from: 0,
      to: 7,
      speed: 12,
      loop: true,
    },
  },
});

loadSprite("groundPlatform", "assets/images/ground3.png");
loadSprite("leftWall", "assets/images/leftWall2.png");
loadSprite("rightWall", "assets/images/rightWall2.png");

// ======================================== MAIN SCENE ========================================
scene("superfluid-test", () => {

  // ======================================== GROUND (BOTTOM) ========================================
  const groundY = VIRTUAL_H;
  for (let i = 0; i < 12; i++) {  // VISUAL GROUND
    add([
      sprite("groundPlatform"),
      pos(i * 250, groundY),
      scale(vec2(2, 1)),
      z(3),
    ]);
  }
  
  add([ // COLLISION GROUND
    rect(VIRTUAL_W*3+250, 80),
    pos(0, groundY),
    area(),
    body({ isStatic: true }),
    opacity(0),
    "ground",
    z(4)
  ]);

  // ======================================== CEILING (TOP - UPSIDE DOWN) ========================================
  const ceilingY = 80;
  for (let i = 0; i < 12; i++) { // VISUAL CEILING 
    add([
      sprite("groundPlatform"),
      pos(i * 250, ceilingY),
      scale(vec2(2, -1)), 
      z(3),
    ]);
  }
  
  add([ // COLLISION CEILING
    rect(VIRTUAL_W*3+250, 80),
    pos(0, 0),
    area(),
    body({ isStatic: true }),
    opacity(0),
    "ceiling",
    z(4)
  ]);

  // ======================================== LEFT WALL ========================================
  for (let i = 0; i < 3; i++) {
    add([
      sprite("leftWall"),
      pos(0, i * 250),
      scale(vec2(1, 1)),
      z(1),
    ]);
  }
  
  add([
    rect(50, VIRTUAL_H),
    pos(0, 0),
    area(),
    body({ isStatic: true }),
    opacity(0),
    "wall",
    z(2)
  ]);

  // ======================================== RIGHT WALL ========================================
  for (let i = 0; i < 3; i++) {
    add([
      sprite("rightWall"),
      pos(VIRTUAL_W*3 + 250, i * 250),
      scale(vec2(1, 1)),
      anchor("topright"),
      z(1),
    ]);
  }
  
  add([
    rect(50, VIRTUAL_H),
    pos(VIRTUAL_W*3 +200, 0),
    area(),
    body({ isStatic: true }),
    opacity(0),
    "wall",
    z(2)
  ]);

  // ======================================== PLAYER (SUPERFLUID CAT) ========================================
  const player = add([
    sprite("niels", { frame: 11 }),
    pos(VIRTUAL_W / 2, groundY - 100),
    area({
      width: 90,
      height: 90,
      offset: vec2(0, 0),
    }),
    body({
      drag: 0,  
    }),
    scale(0.8),
    anchor("center"),
    z(10),
    {
      facingRight: true,
      velocityX: 0, 
      curState: "idle",
    },
    "player"
  ]);



let isCollidingWithWall = false;

player.onCollide("wall", () => {
  isCollidingWithWall = true;
  player.velocityX *= 0.3;  
});

player.onCollideEnd("wall", () => {
  isCollidingWithWall = false;
});


  // ======================================== SUPERFLUID CONTROLS ========================================
player.onUpdate(() => {
  const leftPressed = isKeyDown("left") || virtualKeys.left;
  const rightPressed = isKeyDown("right") || virtualKeys.right;

  if (leftPressed) {  // SUPERFLUID MOVEMENT
    player.velocityX -= ACCELERATION * dt();
    player.facingRight = false;
  }
  
  if (rightPressed) {
    player.velocityX += ACCELERATION * dt();
    player.facingRight = true;
  }

  player.velocityX = Math.max(-MAX_SPEED, Math.min(MAX_SPEED, player.velocityX));
  player.move(player.velocityX, 0);
  updatePlayerAnim(player);
});

  // ======================================== JUMP ========================================
  onKeyPress("space", () => {
    if (player.isGrounded()) {
      player.jump(JUMP_FORCE);
      player.curState = "jumpStart";
      player.use(sprite("niels", { frame: 8 }));
    }
  });

  // ======================================== ANIMATION HELPER ========================================
  function updatePlayerAnim(player) {
    const grounded = player.isGrounded();
    let newState;

    if (!grounded) {
      if (player.vel.y < -700) {
        newState = "jumpStart";  
      } else if (player.vel.y > 20) {
        newState = "fall";      
      } else {
        newState = "jumpMid";   
      }
    } else if (Math.abs(player.velocityX) > 50) {
      newState = "walk";
    } else {
      newState = "idle";
    }

    if (newState !== player.curState) {
      player.curState = newState;

      if (newState === "walk") {
        player.use(sprite("niels"));
        player.play("walk");
      } else if (newState === "jumpStart") {
        player.use(sprite("niels", { frame: 8 }));
        player.stop();
      } else if (newState === "jumpMid") {
        player.use(sprite("niels", { frame: 9 }));
        player.stop();
      } else if (newState === "fall") {
        player.use(sprite("niels", { frame: 10 }));
        player.stop();
      } else {
        player.use(sprite("niels", { frame: 11 }));
        player.stop();
      }
    }

    player.flipX = !player.facingRight;
  }

  // ======================================== CAMERA ========================================
  player.onUpdate(() => {
    setCamPos(player.pos.x, VIRTUAL_H / 2 + 40);
  });

  // ======================================== DEBUG INFO ========================================
  onUpdate(() => {
    const debugText = get("debugInfo")[0];
    if (!debugText) {
      add([
        text("", { size: 12 }),
        pos(10, VIRTUAL_H - 60),
        color(0, 255, 255),
        z(999),
        "debugInfo"
      ]);
    } else {
      debugText.text = `Velocity X: ${player.velocityX.toFixed(1)} | Velocity Y: ${player.vel.y.toFixed(1)}\nPos: (${player.pos.x.toFixed(0)}, ${player.pos.y.toFixed(0)})`;
    }
  });

});

go("superfluid-test");

</script>

</body>
</html>